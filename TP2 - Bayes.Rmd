---
title: |
  \vspace{1cm}
  \begin{tabular}{c}
  {\normalsize\textbf{UNIVERSIDAD NACIONAL DE ROSARIO}}\\
  {\Large Facultad de Ciencias Económicas y Estadística}\\
  \\
  \includegraphics[width=5cm]{LogoUNR.png}\\
  \vspace{1cm}
  \\
  {\huge\textbf{"Metropolis-Hastings"}}\\
  {\Large Estadística Bayesiana - Trabajo Práctico Nº2}\\
  \end{tabular}
  \vspace{5cm}
author: |
  *Alumnas:* Agustina Mac Kay, Ailén Salas y Rocio Canteros
date: "Año 2024"
output: pdf_document
---

```{r setup, warning=FALSE}
#Librerias
library(ggplot2)
library(dplyr)
library(gridExtra)
library(kableExtra)
library(stats)
library(mvtnorm)
set.seed(394)
```

```{r}

cant_saltos <- 0

#Punto 1:
sample_mh <- function(d_objetivo, r_propuesta, d_propuesta, p_inicial, n) {
  muestras <- matrix(nrow = n, ncol = length(p_inicial))
  muestras[1, ] <- p_inicial
  
  for(i in 2:n) {
    p_actual <- muestras[i-1,]
    p_nuevo <- r_propuesta(p_actual)
    
    f_nuevo <- d_objetivo(p_nuevo)
    f_actual <- d_objetivo(p_actual)
    
    q_actual <- d_propuesta(p_actual, mean = p_nuevo)
    q_nuevo <- d_propuesta(p_nuevo, mean = p_actual)
    
    alpha <- min(1, (f_nuevo/f_actual)*(q_actual/q_nuevo))
    aceptar <- rbinom(1, 1, alpha)
    
    if(aceptar) { 
      muestras[i,] <- p_nuevo
      cant_saltos <- cant_saltos + 1
      
    } else {
      muestras[i,] <- p_actual
    }
  }
  
  if (ncol(muestras) == 1) {
    muestras <- as.vector(muestras)
  } 
  return(list(muestras=muestras,cant_saltos=cant_saltos))
}

```



```{r}
#Punto 2
# Crear grilla para los valores de "x"
grid_n <- 200
x_grid <- seq(0, 1, length.out = grid_n)

kumaraswamy <- function(x, a, b){
  a*b*(x^(a-1))*((1-(x^a))^(b-1))
}

a <- c(0.2, 3, 4, 10, 1)
b <- c(0.2, 3, 9, 5, 7)

#Creamos un data frame para graficar la distribución de Kumaraswamy:

data1 <- data.frame(
  Funcion = as.factor(rep(1:5, each = grid_n)),
  Densidad = numeric(5 * grid_n),
  Grilla = rep(x_grid, times = 5)
) 

#Completamos el data frame con las densidades:
for(i in 1:5) {
    indices <- seq(from = 1 + (i - 1) * 200, to = 200 + (i - 1) * 200)
    data1$Densidad[indices] <- kumaraswamy(x_grid, a[i], b[i])
}

# Asigno etiquetas para cada función de kumaraswamy
levels(data1$Funcion) <- c(
  expression(alpha ~ " = 0.2," ~ beta ~ "= 0.2"),
  expression(alpha ~ " = 3," ~ beta ~ "= 3"),
  expression(alpha ~ " = 4," ~ beta ~ "= 9"),
  expression(alpha ~ " = 10," ~ beta ~ "5"),
  expression(alpha ~ " = 1," ~ beta ~ "= 7")
)

ggplot(data = data1, aes(x = Grilla, y = Densidad)) +
  geom_line(size = 0.55) +
  facet_wrap(~Funcion, labeller = label_parsed) +
  theme_bw() +
  labs(x = "x",
       caption = "Gráfico 1: distribución Kumaraswamy con distintos parámetros") + 
  theme(
    strip.background = element_rect(fill = "olivedrab3"),
    plot.caption = element_text(hjust = 0.5)
  )

```


```{r}
#Punto 3
concentracion3 <- c(4,10,20)
tabla3 <- data.frame ( 
  concentracion = rep(concentracion3, each = 5000),
  muestra = numeric(15000)
  )
tasa3 <- numeric(3)

for (i in 1:3) {
#Funciones a usar
d_objetivo3 <- function(x) kumaraswamy(x, 6, 2)
d_propuesta3 <- function(x, mean) dbeta(x, shape1 = mean * concentracion3[i], shape2 = (1-mean) * concentracion3[i])
r_propuesta3 <- function(x) rbeta(1, shape1 = x * concentracion3[i], shape2 = (1-x) * concentracion3[i])
#Donde x hace referencia a mu
n3 <- 5000
p_inicial3 <- rbeta(1,shape1=2,shape2=2)
funcion3 <- sample_mh(d_objetivo3, r_propuesta3, d_propuesta3, p_inicial3, n3)
indices <- seq(from = 1 + (i - 1) * 5000, to = 5000 + (i - 1) * 5000)
tabla3$muestra[indices] <- funcion3$muestras

tasa3[i] <- funcion3$cant_saltos/n3
} 

#Tasa de aceptacion
tabla3_2 <- data.frame(
  Concentracion = c("4","10","20"),
  Tasa_de_aceptacion = tasa3
) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped","hover","condensed")) %>%
  add_footnote("Pie tabla")

#Gata peluda junta
# Agrego una columna con el orden de las muestras
tabla3$orden <- rep(1:5000, times = 3)
tabla3$concentracion <- as.factor(tabla3$concentracion) 


# Gráfico con múltiples líneas
grafico3_1 <- ggplot(data = tabla3, aes(x = orden, y = muestra, group = concentracion, color = concentracion)) +
  geom_line() +
  theme_bw() +
  labs(x = "x", y = "y", color = "Group", caption = "Título grafico") +
  theme(legend.position = "top")  
  
#Trace plots
plot_trace <- function(x){
  data.frame(x = seq_along(x), y = x) %>% 
    ggplot() +
    geom_line(aes(x = x, y = y))
}

grafico3_2 <- plot_trace(tabla3$muestra[1:5000]) + labs (caption = "Titulo grafico")
grafico3_3 <- plot_trace(tabla3$muestra[5001:10000]) + labs (caption = "Titulo grafico")
grafico3_4 <- plot_trace(tabla3$muestra[10001:15000]) + labs (caption = "Titulo grafico")

#Histogramas
plot_hist <- function(x, d_objetivo3) {
  x_seq <- seq(min(x), max(x), length.out = n3)
  df_hist <- data.frame(x = x)
  df_line <- data.frame(x = x_seq, y = d_objetivo3(x_seq))
  
  ggplot(df_hist)+
    geom_histogram(aes(x = x, y =after_stat(density))) +
    geom_line(aes(x = x, y = y), data = df_line, color = "red")
}
grafico3_5 <- plot_hist(tabla3$muestra[1:5000],d_objetivo3) +
  labs (title = "k=4", x = "Muestras", y = "Densidad")
grafico3_6 <- plot_hist(tabla3$muestra[5001:10000],d_objetivo3) +
  labs (title = "k=10", x = "Muestras", y = "Densidad")
grafico3_7 <- plot_hist(tabla3$muestra[10001:15000],d_objetivo3) +
  labs (title = "k=20", x = "Muestras", y = "Densidad")

grid.arrange(grafico3_5,grafico3_6,grafico3_7,nrow=1)

#Graficos de autocorrelacion
a3 <- acf(tabla3$muestra[1:5000])

grafico3_8 <- ggplot()+
  geom_line(aes(y = a3$acf, x = a3$lag)) +
  labs (title = "k=4", x = "Rezago", y = "Autocorrelación")

b3 <- acf(tabla3$muestra[1:5000])

grafico3_9 <- ggplot()+
  geom_line(aes(y = b3$acf, x = b3$lag)) +
  labs (title = "k=10", x = "Rezago", y = "Autocorrelación")

c3 <- acf(tabla3$muestra[1:5000])

grafico3_10 <- ggplot()+
  geom_line(aes(y = c3$acf, x = c3$lag)) +
  labs (title = "k=20", x = "Rezago", y = "Autocorrelación")

grid.arrange(grafico3_8,grafico3_9,grafico3_10,nrow=1)
```



```{r}
#Punto 4
muestra4_1 <- tabla3$muestra[1:5000]
muestra4_2 <- tabla3$muestra[5001:10000]
muestra4_3 <- tabla3$muestra[10001:15000]

#Calculo de la media y los percentiles 5 y 95 para X:
medias <- c(mean(muestra4_1), mean(muestra4_2), mean(muestra4_3))
percentiles <- data.frame(
  Muestra = c("1", "2", "3"),
  Percentile_5 = c(quantile(muestra4_1, prob = c(0.05)),
                  quantile(muestra4_2, prob = c(0.05)),
                  quantile(muestra4_3, prob = c(0.05))
                  ),
  Percentil_95 = c(quantile(muestra4_1, prob = c(0.95)),
                  quantile(muestra4_2, prob = c(0.95)),
                  quantile(muestra4_3, prob = c(0.95))
                  )
)

#Cálculo de la media y los percentiles 5 y 95 para logit(X):
l_m1 <- log((muestra4_1/(1-muestra4_1)))
l_m2 <- log((muestra4_2/(1-muestra4_2)))
l_m3 <- log((muestra4_3/(1-muestra4_3)))


medias_l <- c(mean(l_m1), mean(l_m2), mean(l_m3))
percentiles_l <- data.frame(
  Muestra = c("1", "2", "3"),
  Percentile_5 = c(quantile(l_m1, prob = c(0.05)),
                  quantile(l_m2, prob = c(0.05)),
                  quantile(l_m3, prob = c(0.05))
                  ),
  Percentil_95 = c(quantile(l_m1, prob = c(0.95)),
                  quantile(l_m2, prob = c(0.95)),
                  quantile(l_m3, prob = c(0.95))
                  )
)



```

```{r}
#Paso 7
n7 <- 1000
d_objetivo7 <- function(x) dmvnorm(x,c(0.4,0.75),matrix(c(1.35,0.4,0.4,2.4),nrow=2))
d_propuesta7 <- function(x, mean) dmvnorm(x,mean = mean ,matrix(c(0.4,0,0,0.4),nrow=2))
r_propuesta7 <- function(x) rmvnorm(1, mean = x, sigma = matrix(c(0.4,0,0,0.4),nrow=2))
funcion7 <- sample_mh(d_objetivo7,r_propuesta7,d_propuesta7,c(0,0),n7)
muestra7 <- funcion7$muestras


```

